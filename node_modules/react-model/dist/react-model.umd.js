!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("immer"),require("react")):"function"==typeof define&&define.amd?define(["exports","immer","react"],t):t((e=e||self).reactModel={},e.immer,e.react)}(this,function(e,t,n){var r="default"in t?t.default:t;function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var c={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},mutableState:{},gid:0,uid:0,storeId:0,currentStoreId:"0",withDevTools:!1},a={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},s=function(e,t){try{var n=e.next;return Promise.resolve(a.tryCatch.enable?n(t).catch(function(e){return console.log(e)}):n(t))}catch(e){return Promise.reject(e)}},u=function(e,t){try{var n=function(){return Promise.resolve(s(t))},r=e.action,i=e.modelName,c=e.consumerActions,a=e.params,s=e.next,u=e.Global,l=e.type,f=function(){if("u"!==l)return Promise.resolve(r(a,o({actions:c(u.Actions[i],{modelName:i}),state:u.State[i]},u.Context.__global||{},u.Context[i]||{}))).then(function(t){e.newState=t||null});e.newState=r()}();return Promise.resolve(f&&f.then?f.then(n):n())}catch(e){return Promise.reject(e)}},l=function(e,t){try{var n=e.modelName,r=e.newState,o=e.next,i=e.Global,c=e.type;return i.Setter.functionSetter[n]&&!e.disableSelectorUpdate&&Object.keys(i.Setter.functionSetter[n]).map(function(e){var t=i.Setter.functionSetter[n][e];t&&t.selector&&!t.selectorRef&&(t.selectorRef=t.selector(i.State[n]))}),Promise.resolve(function(){if(r||"u"===c)return N(n,r||{}),Promise.resolve(o(t))}())}catch(e){return Promise.reject(e)}},f=function(e,t){try{var n=e.modelName,r=e.next,o=e.Global,i=e.__hash,c=o.Setter.functionSetter[n];return"f"===e.type&&i&&c&&c[i]&&c[i].setState&&c[i].setState(o.State[n]),Promise.resolve(r(t))}catch(e){return Promise.reject(e)}},m=function(e,t){try{var n=e.modelName,r=e.next,o=e.Global,i="u"===e.type?o.subscriptions[n]:o.subscriptions[n+"_"+e.actionName];return i&&i.forEach(function(t){t(e)}),Promise.resolve(r(t))}catch(e){return Promise.reject(e)}},d=function(e,t){try{var n=e.Global;return!0===a.logger.enable||"function"==typeof a.logger.enable&&a.logger.enable(e)?(console.group("%c "+e.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",n.State[e.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",e.actionName,"payload: "+e.params),Promise.resolve(e.next(t)).then(function(t){return console.log("%c Next","color: #4CAF50; font-weight: bold",n.State[e.modelName]),console.groupEnd(),t})):Promise.resolve(e.next(t))}catch(e){return Promise.reject(e)}},S=function(e,t){try{var n=e.Global;return Promise.resolve(e.next(t)).then(function(t){return n.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,n.withDevTools&&v.config.devtools.enable&&!n.devTools&&(n.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,n.devTools.connect()),n.withDevTools&&a.devtools.enable&&n.devTools.send("u"===e.type&&e.disableSelectorUpdate?"store["+e.modelName+"].update":e.modelName+"_"+e.actionName,n.mutableState[e.modelName],void 0,e.modelName),t})}catch(e){return Promise.reject(e)}},p=function(e,t){try{var n=e.modelName,r=e.next,o=e.Global,i=e.disableSelectorUpdate;return o.Setter.classSetter&&o.Setter.classSetter(o.State),o.Setter.functionSetter[n]&&Object.keys(o.Setter.functionSetter[n]).map(function(e){var t=o.Setter.functionSetter[n][e];if(t)if(!t.selector||i)t.setState(o.State[n]);else{var r=t.selector(o.State[n]);A(r,t.selectorRef)||(t.selectorRef=r,t.setState(o.State[n]))}}),Promise.resolve(r(t))}catch(e){return Promise.reject(e)}},b=[s,d,S,u,l,f,p,m],v={communicator:p,consoleDebugger:d,devToolsListener:S,getNewState:u,getNewStateWithCache:function(e){return void 0===e&&(e=5e3),function(t,n){try{var r=t.Global,o=t.modelName,i=t.next,c=t.actionName;return Promise.resolve(Promise.race([(0,t.action)(t.params,{actions:(0,t.consumerActions)(r.Actions[o],{modelName:o}),state:r.State[o]}),E(e,j(o,c))])).then(function(e){return t.newState=e||null,Promise.resolve(i(n))})}catch(e){return Promise.reject(e)}}},setNewState:l,stateUpdater:f,subscription:m,tryCatch:s,config:a},_=function(e,t){try{return t.next=function(e){return e.length>0?e[0](t,e.slice(1)):t.newState},Promise.resolve(e[0](t,e.slice(1)))}catch(e){return Promise.reject(e)}},h=n.createContext({}),y=h.Consumer;if(!console.group){var g=[],P="-".repeat(80);console.group=function(e){g.push(e),console.log("%c \nBEGIN GROUP: %c",P,e),console.groupEnd=function(){console.log("END GROUP: %c\n%c",g.pop(),P)}}}var w=function(e,t){var n={};return Object.keys(e).forEach(function(r){n[r]=function(e,t){return function(n,r){try{return Promise.resolve(_(b,{Global:c,action:e,actionName:e.name,consumerActions:w,middlewareConfig:r,modelName:t.modelName,newState:null,params:n,type:"o"}))}catch(e){return Promise.reject(e)}}}(e[r],t)}),n},N=function(e,t){if("function"==typeof t){var n=c.State[e];n=r(n,t),c.State=r(c.State,function(t){t[e]=n})}else c.State=r(c.State,function(n){n[e]=o({},n[e],t)});return c.State},E=function(e,t){return new Promise(function(n){return setTimeout(function(){console.log(e),n(t)},e)})},O=function(e,t){try{var n={__FROM_SERVER__:!0};return Promise.resolve(Promise.all(Object.keys(c.State).map(function(i){try{var a=t&&t.prefix||"",s=function(){if(!e||!e.modelName||i===a+e.modelName||-1!==e.modelName.indexOf(a+i)){var s=function(e){t&&t.isServer?n[i]=e:c.State=r(c.State,function(t){t[i]=o({},t[i],e)})},u=c.AsyncState[i];return u?Promise.resolve(u(e)).then(s):s({})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}))).then(function(){return t&&t.isServer?n:c.State})}catch(e){return Promise.reject(e)}},j=function(e,t){var n=localStorage.getItem("__REACT_MODELX__"+e+"_"+t);return n?JSON.parse(n):null},A=function(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var o=0;o<n.length;o++)if(!Object.prototype.hasOwnProperty.call(t,n[o])||e[n[o]]!==t[n[o]])return!1;return!0};t.enableES5();var R="undefined"==typeof window?n.useEffect:n.useLayoutEffect,x=function(e,t){C(e,t,void 0)},C=function(e,t,n){Array.isArray(t)?t.forEach(function(t){c.subscriptions[e+"_"+t]||(c.subscriptions[e+"_"+t]=[]),n?c.subscriptions[e+"_"+t].push(n):c.subscriptions[e+"_"+t]=[]}):(c.subscriptions[e+"_"+t]||(c.subscriptions[e+"_"+t]=[]),n?c.subscriptions[e+"_"+t].push(n):c.subscriptions[e+"_"+t]=[])},T=function(e){return c.State[e]},M=function(e,t){void 0===t&&(t={type:"o"});var n={};return Object.keys(c.Actions[e]).forEach(function(r){return n[r]=function(n,i){try{var a=o({action:c.Actions[e][r],actionName:r,consumerActions:w,middlewareConfig:i,modelName:e,newState:null,params:n},t,{Global:c});return Promise.resolve(_(c.Middlewares[e]?c.Middlewares[e]:b,a))}catch(e){return Promise.reject(e)}}}),n},I=function(e,t){var r,o=n.useState({})[1],i=n.useRef(""),a=(r=[e],function(e){return r.reduce(function(e,t){return e&&e[t]?e[t]:null},e)})(c.mutableState),s=!!a,u=s?a.selector:t,l=s?a:T(e);if(R(function(){c.uid+=1;var t=""+c.uid;return i.current=t,c.Setter.functionSetter[e]||(c.Setter.functionSetter[e]={}),c.Setter.functionSetter[e][t]={setState:o,selector:u},function(){delete c.Setter.functionSetter[e][t]}},[]),s)return u(l);var f=M(e,{__hash:i.current,type:"f"});return[u?u(l):l,f]},G=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state=c.State,t}return i(t,e),t.prototype.render=function(){var e=this.props.children;return c.Setter.classSetter=this.setState.bind(this),n.createElement(h.Provider,{value:o({},this.state)},e)},t}(n.PureComponent);e.Consumer=y,e.Model=function(e,t,n){if(void 0!==e.state){c.storeId+=1;var i="__"+c.storeId;c.State=r(c.State,function(t){t[i]=e.state}),e.middlewares&&(c.Middlewares[i]=e.middlewares),c.Actions[i]=e.actions,c.AsyncState[i]=e.asyncState,t&&(c.Context[i]=t);var a=M(i);return{__id:i,actions:a,getState:function(){return T(i)},subscribe:function(e,t){return C(i,e,t)},unsubscribe:function(e){return x(i,e)},useStore:function(e){return I(i,e)}}}t?c.gid=1:c.gid+=1;var s="";if(c.gid>1&&(s=c.gid+"_"),e.actions){console.error("invalid model(s) schema: ",e);var u=function(e){return function(){return e}};return{__ERROR__:!0,actions:u({}),getActions:u({}),getInitialState:u({}),getState:u({}),subscribe:u(),unsubscribe:u(),useStore:u([{},{}])}}t&&!t.__FROM_SERVER__&&(c.State=r(c.State,function(e){Object.assign(e,t||{})})),n&&(c.Context.__global=n);var l={};return Object.keys(e).forEach(function(n){var i=s+n,a=e[n];if(a.__ERROR__)return console.error(i+" model's schema is invalid"),c.State=r(c.State,function(e){e[i]={}}),void(c.Actions[i]={});void 0===a.useStore?(t&&t.__FROM_SERVER__?c.State=r(c.State,function(e){e[i]=o({},a.state,t[i])}):c.State[i]||(c.State=r(c.State,function(e){e[i]=a.state})),a.middlewares&&(c.Middlewares[i]=a.middlewares),c.Actions[i]=a.actions,c.AsyncState[i]=a.asyncState):(c.State[i]&&t||(c.State=r(c.State,function(e){e[i]=e[a.__id]})),t&&t.__FROM_SERVER__&&(c.State=r(c.State,function(e){e[i]=o({},e[a.__id],t[i])})),c.Actions[i]=c.Actions[a.__id],c.AsyncState[i]=c.AsyncState[a.__id],c.Middlewares[i]=c.Middlewares[a.__id],c.Context[i]=c.Context[a.__id]),l[n]=M(i)}),{actions:l,getActions:function(e){return M(s+e)},getInitialState:function(e,t){try{return Promise.resolve(O(e,o({},t,{prefix:s})))}catch(e){return Promise.reject(e)}},getState:function(e){return T(s+e)},subscribe:function(e,t,n){return C(s+e,t,n)},unsubscribe:function(e,t){return x(s+e,t)},useStore:function(e,t){return I(s+e,t)}}},e.Provider=G,e.actionMiddlewares=b,e.connect=function(e,t,r){return function(a){return function(s){function u(){return s.apply(this,arguments)||this}return i(u,s),u.prototype.render=function(){var i=this,s=this.props,u=s.state,l=void 0===u?{}:u,f=s.actions,m=void 0===f?{}:f;return n.createElement(y,null,function(s){var u=s[""+e],f=c.Actions[e];return n.createElement(a,Object.assign({},i.props,{state:o({},l,t?t(u):u),actions:o({},m,r?r(w(f,{modelName:e})):w(f,{modelName:e}))}))})},u}(n.PureComponent)}},e.createStore=function(e,t){var n="string"==typeof e;c.storeId+=n?0:1;var r=n?e:c.storeId.toString();c.Actions[r]||(c.Actions[r]={}),c.mutableState[r]||(c.mutableState[r]={count:0});var o=function(){return c.mutableState[r].count=0,c.currentStoreId=r,t?t():e()};return c.mutableState[r].selector=o,{useStore:function(){return I(r,o)},getState:function(){return o()},subscribe:function(e){c.subscriptions[r]||(c.subscriptions[r]=[]),c.subscriptions[r].push(e)},unsubscribe:function(e){if(c.subscriptions[r]&&e){var t=c.subscriptions[r].indexOf(e);t>=0&&c.subscriptions[r].splice(t,1)}}}},e.getInitialState=O,e.getState=T,e.middlewares=v,e.useModel=function(e){var t=c.currentStoreId,n=c.mutableState[t].count;return c.mutableState[t].count+=1,c.mutableState[t].hasOwnProperty(n)||(c.mutableState[t][n]="function"==typeof e?e():e),[c.mutableState[t][n],function(e){try{return c.mutableState[t][n]="function"==typeof e?r(c.mutableState[t][n],e):c.mutableState[t][n]&&e&&"Object"===c.mutableState[t][n].constructor.name&&"Object"===e.constructor.name?o({},c.mutableState[t][n],e):e,Promise.resolve(_(b,{Global:c,action:function(){return"function"==typeof e?c.mutableState[t][n]:e},actionName:"setter",consumerActions:w,disableSelectorUpdate:!0,middlewareConfig:{},modelName:t,newState:{},params:void 0,type:"u"}))}catch(e){return Promise.reject(e)}}]}});
