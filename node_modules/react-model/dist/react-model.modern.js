import t,{enableES5 as e}from"immer";import{createContext as o,useState as n,useRef as a,PureComponent as s,createElement as r,useEffect as c,useLayoutEffect as i}from"react";var l={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},mutableState:{},gid:0,uid:0,storeId:0,currentStoreId:"0",withDevTools:!1};const u={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},S=async(t,e)=>{const{next:o}=t;return u.tryCatch.enable?await o(e).catch(t=>console.log(t)):await o(e)},d=async(t,e)=>{const{action:o,modelName:n,consumerActions:a,params:s,next:r,Global:c,type:i}=t;return t.newState="u"===i?o():await o(s,{actions:a(c.Actions[n],{modelName:n}),state:c.State[n],...c.Context.__global||{},...c.Context[n]||{}})||null,await r(e)},m=async(t,e)=>{const{modelName:o,newState:n,next:a,Global:s,disableSelectorUpdate:r,type:c}=t;if(s.Setter.functionSetter[o]&&!r&&Object.keys(s.Setter.functionSetter[o]).map(t=>{const e=s.Setter.functionSetter[o][t];e&&e.selector&&!e.selectorRef&&(e.selectorRef=e.selector(s.State[o]))}),n||"u"===c)return E(o,n||{}),await a(e)},b=async(t,e)=>{const{modelName:o,next:n,Global:a,__hash:s}=t,r=a.Setter.functionSetter[o];return"f"===t.type&&s&&r&&r[s]&&r[s].setState&&r[s].setState(a.State[o]),await n(e)},p=async(t,e)=>{const{modelName:o,actionName:n,next:a,Global:s}=t,r="u"===t.type?s.subscriptions[o]:s.subscriptions[`${o}_${n}`];return r&&r.forEach(e=>{e(t)}),await a(e)},_=async(t,e)=>{const{Global:o}=t;if(!0===u.logger.enable||"function"==typeof u.logger.enable&&u.logger.enable(t)){console.group(`%c ${t.modelName} State Change %c ${(new Date).toLocaleTimeString()}`,"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",o.State[t.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",t.actionName,"payload: "+t.params);const n=await t.next(e);return console.log("%c Next","color: #4CAF50; font-weight: bold",o.State[t.modelName]),console.groupEnd(),n}return await t.next(e)},f=async(t,e)=>{const{Global:o}=t,n=await t.next(e);return o.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,o.withDevTools&&y.config.devtools.enable&&!o.devTools&&(o.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,o.devTools.connect()),o.withDevTools&&u.devtools.enable&&o.devTools.send("u"===t.type&&t.disableSelectorUpdate?`store[${t.modelName}].update`:`${t.modelName}_${t.actionName}`,o.mutableState[t.modelName],void 0,t.modelName),n},w=async(t,e)=>{const{modelName:o,next:n,Global:a,disableSelectorUpdate:s}=t;return a.Setter.classSetter&&a.Setter.classSetter(a.State),a.Setter.functionSetter[o]&&Object.keys(a.Setter.functionSetter[o]).map(t=>{const e=a.Setter.functionSetter[o][t];if(e)if(!e.selector||s)e.setState(a.State[o]);else{const t=e.selector(a.State[o]);$(t,e.selectorRef)||(e.selectorRef=t,e.setState(a.State[o]))}}),await n(e)},g=[S,_,f,d,m,b,w,p],y={communicator:w,consoleDebugger:_,devToolsListener:f,getNewState:d,getNewStateWithCache:(t=5e3)=>async(e,o)=>{const{action:n,Global:a,modelName:s,consumerActions:r,params:c,next:i,actionName:l}=e;return e.newState=await Promise.race([n(c,{actions:r(a.Actions[s],{modelName:s}),state:a.State[s]}),v(t,x(s,l))])||null,await i(o)},setNewState:m,stateUpdater:b,subscription:p,tryCatch:S,config:u},h=async(t,e)=>(e.next=t=>t.length>0?t[0](e,t.slice(1)):e.newState,await t[0](e,t.slice(1))),N=o({}),O=N.Consumer;if(!console.group){const t=[],e="-".repeat(80);console.group=function(o){t.push(o),console.log("%c \nBEGIN GROUP: %c",e,o),console.groupEnd=function(){console.log("END GROUP: %c\n%c",t.pop(),e)}}}const A=(t,e)=>{const o={};return Object.keys(t).forEach(n=>{o[n]=((t,e)=>async(o,n)=>{const a={Global:l,action:t,actionName:t.name,consumerActions:A,middlewareConfig:n,modelName:e.modelName,newState:null,params:o,type:"o"};return await h(g,a)})(t[n],e)}),o},E=(e,o)=>{if("function"==typeof o){let n=l.State[e];n=t(n,o),l.State=t(l.State,t=>{t[e]=n})}else l.State=t(l.State,t=>{t[e]={...t[e],...o}});return l.State},v=(t,e)=>new Promise(o=>setTimeout(()=>{console.log(t),o(e)},t)),R=async(e,o)=>{const n={__FROM_SERVER__:!0};return await Promise.all(Object.keys(l.State).map(async a=>{let s=o&&o.prefix||"";if(!e||!e.modelName||a===s+e.modelName||-1!==e.modelName.indexOf(s+a)){const s=l.AsyncState[a],r=s?await s(e):{};o&&o.isServer?n[a]=r:l.State=t(l.State,t=>{t[a]={...t[a],...r}})}})),o&&o.isServer?n:l.State},x=(t,e)=>{const o=localStorage.getItem(`__REACT_MODELX__${t}_${e}`);return o?JSON.parse(o):null},$=(t,e)=>{if(t===e)return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;const o=Object.keys(t),n=Object.keys(e);if(o.length!==n.length)return!1;for(let n=0;n<o.length;n++)if(!Object.prototype.hasOwnProperty.call(e,o[n])||t[o[n]]!==e[o[n]])return!1;return!0};e();const C="undefined"==typeof window?c:i;function T(e){const o=l.currentStoreId,n=l.mutableState[o].count;return l.mutableState[o].count+=1,l.mutableState[o].hasOwnProperty(n)||(l.mutableState[o][n]="function"==typeof e?e():e),[l.mutableState[o][n],async e=>{l.mutableState[o][n]="function"==typeof e?t(l.mutableState[o][n],e):l.mutableState[o][n]&&e&&"Object"===l.mutableState[o][n].constructor.name&&"Object"===e.constructor.name?{...l.mutableState[o][n],...e}:e;const a={Global:l,action:()=>"function"==typeof e?l.mutableState[o][n]:e,actionName:"setter",consumerActions:A,disableSelectorUpdate:!0,middlewareConfig:{},modelName:o,newState:{},params:void 0,type:"u"};return await h(g,a)}]}function j(t,e){const o="string"==typeof t;l.storeId+=o?0:1;const n=o?t:l.storeId.toString();l.Actions[n]||(l.Actions[n]={}),l.mutableState[n]||(l.mutableState[n]={count:0});const a=()=>(l.mutableState[n].count=0,l.currentStoreId=n,e?e():t());return l.mutableState[n].selector=a,{useStore:()=>P(n,a),getState:()=>a(),subscribe:t=>{l.subscriptions[n]||(l.subscriptions[n]=[]),l.subscriptions[n].push(t)},unsubscribe:t=>{if(l.subscriptions[n]&&t){const e=l.subscriptions[n].indexOf(t);e>=0&&l.subscriptions[n].splice(e,1)}}}}function G(e,o,n){if(void 0!==e.state){l.storeId+=1;const n="__"+l.storeId;l.State=t(l.State,t=>{t[n]=e.state}),e.middlewares&&(l.Middlewares[n]=e.middlewares),l.Actions[n]=e.actions,l.AsyncState[n]=e.asyncState,o&&(l.Context[n]=o);const a=k(n);return{__id:n,actions:a,getState:()=>M(n),subscribe:(t,e)=>D(n,t,e),unsubscribe:t=>I(n,t),useStore:t=>P(n,t)}}{o?l.gid=1:l.gid+=1;let a="";if(l.gid>1&&(a=l.gid+"_"),e.actions){console.error("invalid model(s) schema: ",e);const t=t=>(...e)=>t;return{__ERROR__:!0,actions:t({}),getActions:t({}),getInitialState:t({}),getState:t({}),subscribe:t(),unsubscribe:t(),useStore:t([{},{}])}}o&&!o.__FROM_SERVER__&&(l.State=t(l.State,t=>{Object.assign(t,o||{})})),n&&(l.Context.__global=n);let s={};return Object.keys(e).forEach(n=>{let r=a+n;const c=e[n];if(c.__ERROR__)return console.error(r+" model's schema is invalid"),l.State=t(l.State,t=>{t[r]={}}),void(l.Actions[r]={});(t=>void 0!==t.useStore)(c)?(l.State[r]&&o||(l.State=t(l.State,t=>{t[r]=t[c.__id]})),o&&o.__FROM_SERVER__&&(l.State=t(l.State,t=>{t[r]={...t[c.__id],...o[r]}})),l.Actions[r]=l.Actions[c.__id],l.AsyncState[r]=l.AsyncState[c.__id],l.Middlewares[r]=l.Middlewares[c.__id],l.Context[r]=l.Context[c.__id]):(o&&o.__FROM_SERVER__?l.State=t(l.State,t=>{t[r]={...c.state,...o[r]}}):l.State[r]||(l.State=t(l.State,t=>{t[r]=c.state})),c.middlewares&&(l.Middlewares[r]=c.middlewares),l.Actions[r]=c.actions,l.AsyncState[r]=c.asyncState),s[n]=k(r)}),{actions:s,getActions:t=>k(a+t),getInitialState:async(t,e)=>R(t,{...e,prefix:a}),getState:t=>M(a+t),subscribe:(t,e,o)=>D(a+t,e,o),unsubscribe:(t,e)=>I(a+t,e),useStore:(t,e)=>P(a+t,e)}}}const I=(t,e)=>{D(t,e,void 0)},D=(t,e,o)=>{Array.isArray(e)?e.forEach(e=>{l.subscriptions[`${t}_${e}`]||(l.subscriptions[`${t}_${e}`]=[]),o?l.subscriptions[`${t}_${e}`].push(o):l.subscriptions[`${t}_${e}`]=[]}):(l.subscriptions[`${t}_${e}`]||(l.subscriptions[`${t}_${e}`]=[]),o?l.subscriptions[`${t}_${e}`].push(o):l.subscriptions[`${t}_${e}`]=[])},M=t=>l.State[t],k=(t,e={type:"o"})=>{const o={};return Object.keys(l.Actions[t]).forEach(n=>o[n]=async(o,a)=>{const s={action:l.Actions[t][n],actionName:n,consumerActions:A,middlewareConfig:a,modelName:t,newState:null,params:o,...e,Global:l};return l.Middlewares[t]?await h(l.Middlewares[t],s):await h(g,s)}),o},P=(t,e)=>{const o=n({})[1],s=a(""),r=(c=[t],t=>c.reduce((t,e)=>t&&t[e]?t[e]:null,t))(l.mutableState);var c;const i=!!r,u=i?r.selector:e,S=i?r:M(t);if(C(()=>{l.uid+=1;const e=""+l.uid;return s.current=e,l.Setter.functionSetter[t]||(l.Setter.functionSetter[t]={}),l.Setter.functionSetter[t][e]={setState:o,selector:u},function(){delete l.Setter.functionSetter[t][e]}},[]),i)return u(S);{const e=k(t,{__hash:s.current,type:"f"});return[u?u(S):S,e]}};class U extends s{constructor(){super(...arguments),this.state=l.State}render(){const{children:t}=this.props;return l.Setter.classSetter=this.setState.bind(this),r(N.Provider,{value:{...this.state}},t)}}const F=(t,e,o)=>n=>class extends s{render(){const{state:a={},actions:s={}}=this.props;return r(O,null,c=>{const{[""+t]:i}=c,u=l.Actions[t];return r(n,Object.assign({},this.props,{state:{...a,...e?e(i):i},actions:{...s,...o?o(A(u,{modelName:t})):A(u,{modelName:t})}}))})}};export{O as Consumer,G as Model,U as Provider,g as actionMiddlewares,F as connect,j as createStore,R as getInitialState,M as getState,y as middlewares,T as useModel};
